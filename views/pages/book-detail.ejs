<div class="container mt-5">
  <div class="row">
    <!-- Coluna da Imagem -->
    <div class="col-md-4">
      <% if (book.cover && book.cover.url) { %>
        <img src="<%= book.cover.url %>" alt="<%= book.title %>" class="img-fluid rounded shadow">
      <% } else if (book.coverImage) { %>
        <img src="<%= book.coverImage %>" alt="<%= book.title %>" class="img-fluid rounded shadow">
      <% } else { %>
        <div class="bg-light p-5 text-center rounded">
          <i class="fas fa-book fa-5x text-muted"></i>
        </div>
      <% } %>

      <!-- Ações -->
      <div class="mt-4">
        <% if (book.pdf) { %>
          <a href="/books/<%= book._id %>/download" class="btn btn-success btn-block">
            <i class="fas fa-download"></i> Download PDF
          </a>
        <% } %>
        <% if (book.url) { %>
          <a href="<%= book.url %>" target="_blank" class="btn btn-primary btn-block mt-2">
            <i class="fas fa-external-link-alt"></i> Ver Online
          </a>
        <% } %>
        <% if (book.repository) { %>
          <a href="<%= book.repository %>" target="_blank" class="btn btn-dark btn-block mt-2">
            <i class="fab fa-github"></i> Repositório
          </a>
        <% } %>
      </div>

      <!-- Estatísticas -->
      <div class="card mt-4">
        <div class="card-body">
          <h6 class="card-title">Estatísticas</h6>
          <div class="d-flex justify-content-between">
            <small><i class="fas fa-eye"></i> <%= book.views || 0 %> visualizações</small>
          </div>
          <div class="d-flex justify-content-between">
            <small><i class="fas fa-download"></i> <%= book.downloads || 0 %> downloads</small>
          </div>
          <div class="d-flex justify-content-between">
            <small><i class="fas fa-thumbs-up"></i> <%= book.likes || 0 %> likes</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Coluna do Conteúdo -->
    <div class="col-md-8">
      <h1 class="mb-3"><%= book.title %></h1>

      <!-- Informações do Autor -->
      <% if (book.author) { %>
        <div class="card mb-4">
          <div class="card-body">
            <h6 class="card-title">Autor</h6>
            <div class="d-flex align-items-center">
              <% if (book.author.fotoPerfil && book.author.fotoPerfil.url) { %>
                <img src="<%= book.author.fotoPerfil.url %>" alt="<%= book.author.nomeReferencial %>" 
                     class="rounded-circle me-3" width="50" height="50">
              <% } %>
              <div>
                <h6 class="mb-1"><%= book.author.nomeReferencial %></h6>
                <small class="text-muted">@<%= book.author.username %></small>
                <% if (book.author.bio) { %>
                  <p class="mt-2 mb-0"><%= book.author.bio %></p>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      <% } %>

      <!-- Metadados -->
      <div class="row mb-4">
        <% if (book.code) { %>
          <div class="col-md-6">
            <strong>Código:</strong> <%= book.code %>
          </div>
        <% } %>
        <% if (book.publishedYear) { %>
          <div class="col-md-6">
            <strong>Ano:</strong> <%= book.publishedYear %>
          </div>
        <% } %>
        <% if (book.theme) { %>
          <div class="col-md-6">
            <strong>Tema:</strong> <%= book.theme %>
          </div>
        <% } %>
        <% if (book.pages) { %>
          <div class="col-md-6">
            <strong>Páginas:</strong> <%= book.pages %>
          </div>
        <% } %>
        <% if (book.language) { %>
          <div class="col-md-6">
            <strong>Idioma:</strong> <%= book.language %>
          </div>
        <% } %>
      </div>

      <!-- Descrição -->
      <div class="mb-4">
        <h4>Descrição</h4>
        <p><%= book.description %></p>
      </div>

      <!-- Sinopse -->
      <% if (book.sinopsis && book.sinopsis !== book.description) { %>
        <div class="mb-4">
          <h4>Sinopse</h4>
          <p><%= book.sinopsis %></p>
        </div>
      <% } %>

      <!-- Tags -->
      <% if (book.tags && book.tags.length > 0) { %>
        <div class="mb-4">
          <h5>Tags</h5>
          <% book.tags.forEach(tag => { %>
            <span class="badge badge-secondary mr-2"><%= tag %></span>
          <% }); %>
        </div>
      <% } %>

      <!-- Documentações -->
      <% if (book.documentations && book.documentations.length > 0) { %>
        <div class="mb-4">
          <h5>Documentações</h5>
          <ul class="list-unstyled">
            <% book.documentations.forEach(doc => { %>
              <li><a href="<%= doc %>" target="_blank"><%= doc %></a></li>
            <% }); %>
          </ul>
        </div>
      <% } %>

      <!-- Avaliações -->
      <div class="card mb-4">
        <div class="card-header">
          <h5>Avaliações</h5>
        </div>
        <div class="card-body">
          <% if (book.ratings && book.ratings.length > 0) { %>
            <% let totalRating = book.ratings.reduce((sum, r) => sum + r.rating, 0); %>
            <% let avgRating = (totalRating / book.ratings.length).toFixed(1); %>
            <div class="mb-3">
              <strong>Média: <%= avgRating %>/5</strong> (<%= book.ratings.length %> avaliações)
              <div class="rating-stars">
                <% for(let i = 1; i <= 5; i++) { %>
                  <% if (i <= avgRating) { %>
                    ⭐
                  <% } else { %>
                    ☆
                  <% } %>
                <% } %>
              </div>
            </div>
          <% } else { %>
            <p>Nenhuma avaliação ainda.</p>
          <% } %>

          <!-- Formulário de Avaliação -->
          <form action="/books/<%= book._id %>/rating" method="POST" class="mb-3">
            <div class="form-group">
              <label>Sua Avaliação:</label>
              <select name="rating" class="form-control" required>
                <option value="">Selecione uma nota</option>
                <option value="1">1 - Muito ruim</option>
                <option value="2">2 - Ruim</option>
                <option value="3">3 - Regular</option>
                <option value="4">4 - Bom</option>
                <option value="5">5 - Excelente</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Avaliar</button>
          </form>
        </div>
      </div>

      <!-- Comentários -->
      <div class="card">
        <div class="card-header">
          <h5>Comentários</h5>
        </div>
        <div class="card-body">
          <% if (book.comments && book.comments.length > 0) { %>
            <% book.comments.forEach(comment => { %>
              <div class="media mb-3">
                <div class="media-body">
                  <h6 class="mt-0"><%= comment.user.username %></h6>
                  <small class="text-muted"><%= new Date(comment.date).toLocaleDateString('pt-BR') %></small>
                  <p><%= comment.comment %></p>
                </div>
              </div>
              <hr>
            <% }); %>
          <% } else { %>
            <p>Nenhum comentário ainda.</p>
          <% } %>

          <!-- Formulário de Comentário -->
          <form action="/books/<%= book._id %>/comment" method="POST">
            <div class="form-group">
              <label>Seu Comentário:</label>
              <textarea name="comment" class="form-control" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Comentar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Botão Voltar -->
  <div class="row mt-4">
    <div class="col-12">
      <a href="/books" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Voltar à Biblioteca
      </a>
    </div>
  </div>
</div>

<style>
.rating-stars {
  font-size: 1.2em;
}

.card {
  border-radius: 10px;
}

.media {
  display: flex;
  align-items: flex-start;
}

.media-body {
  flex: 1;
}

.badge {
  margin-right: 5px;
  margin-bottom: 5px;
}
</style>